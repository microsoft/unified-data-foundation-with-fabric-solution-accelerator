{
    "I need to understand our customer base better. Can you show me a breakdown of customers by relationship type and gender, including their average age and activity status? I want to see which customer segments we should focus on for our upcoming marketing campaign.": "-- Customer Segmentation Analysis - Detailed View by Relationship Type and Gender\r\nWITH customer_segmentation AS (\r\n    SELECT \r\n        CustomerRelationshipTypeId,\r\n        Gender,\r\n        DATEDIFF(YEAR, DateOfBirth, GETDATE()) AS Age,\r\n        IsActive\r\n    FROM shared.customer\r\n    WHERE DateOfBirth IS NOT NULL \r\n      AND Gender IS NOT NULL\r\n),\r\n\r\nsegmentation_metrics AS (\r\n    SELECT \r\n        CustomerRelationshipTypeId,\r\n        Gender,\r\n        COUNT(*) AS CustomerCount,\r\n        ROUND(AVG(CAST(Age AS FLOAT)), 1) AS AvgAge,\r\n        SUM(CASE WHEN IsActive = 'True' THEN 1 ELSE 0 END) AS ActiveCustomers,\r\n        SUM(CASE WHEN IsActive = 'False' THEN 1 ELSE 0 END) AS InactiveCustomers,\r\n        ROUND(\r\n            (SUM(CASE WHEN IsActive = 'True' THEN 1 ELSE 0 END) * 100.0 / COUNT(*)), \r\n            1\r\n        ) AS ActivePercentage\r\n    FROM customer_segmentation\r\n    GROUP BY CustomerRelationshipTypeId, Gender\r\n),\r\n\r\ntotal_customers AS (\r\n    SELECT COUNT(*) AS TotalCount\r\n    FROM customer_segmentation\r\n)\r\n\r\nSELECT \r\n    sm.CustomerRelationshipTypeId AS [Relationship Type],\r\n    sm.Gender,\r\n    sm.CustomerCount AS [Total Customers],\r\n    CONCAT(sm.AvgAge, ' years') AS [Average Age],\r\n    CONCAT(sm.ActiveCustomers, ' / ', sm.InactiveCustomers) AS [Active / Inactive],\r\n    CONCAT(CAST(sm.ActivePercentage AS DECIMAL(5,1)), '%') AS [Activity Rate],\r\n    CONCAT(CAST(ROUND((sm.CustomerCount * 100.0 / tc.TotalCount), 1) AS DECIMAL(5,1)), '%') AS [% of Total Base]\r\nFROM segmentation_metrics sm\r\nCROSS JOIN total_customers tc\r\nORDER BY \r\n    sm.CustomerCount DESC, \r\n    sm.CustomerRelationshipTypeId, \r\n    CASE WHEN sm.Gender = 'Male' THEN 1 ELSE 2 END;\r\n\r\n-- Executive Summary by Relationship Type Only\r\nWITH customer_segmentation AS (\r\n    SELECT \r\n        CustomerRelationshipTypeId,\r\n        Gender,\r\n        DATEDIFF(YEAR, DateOfBirth, GETDATE()) AS Age,\r\n        IsActive\r\n    FROM shared.customer\r\n    WHERE DateOfBirth IS NOT NULL \r\n      AND Gender IS NOT NULL\r\n),\r\n\r\nsegmentation_metrics AS (\r\n    SELECT \r\n        CustomerRelationshipTypeId,\r\n        Gender,\r\n        COUNT(*) AS CustomerCount,\r\n        ROUND(AVG(CAST(Age AS FLOAT)), 1) AS AvgAge,\r\n        SUM(CASE WHEN IsActive = 'True' THEN 1 ELSE 0 END) AS ActiveCustomers,\r\n        ROUND(\r\n            (SUM(CASE WHEN IsActive = 'True' THEN 1 ELSE 0 END) * 100.0 / COUNT(*)), \r\n            1\r\n        ) AS ActivePercentage\r\n    FROM customer_segmentation\r\n    GROUP BY CustomerRelationshipTypeId, Gender\r\n),\r\n\r\ntotal_customers AS (\r\n    SELECT COUNT(*) AS TotalCount\r\n    FROM customer_segmentation\r\n)\r\n\r\nSELECT \r\n    CustomerRelationshipTypeId AS [Relationship Type],\r\n    SUM(CustomerCount) AS [Total Customers],\r\n    CONCAT(ROUND(AVG(AvgAge), 1), ' years') AS [Average Age],\r\n    SUM(ActiveCustomers) AS [Active Customers],\r\n    CONCAT(CAST(ROUND(AVG(ActivePercentage), 1) AS DECIMAL(5,1)), '%') AS [Average Activity Rate],\r\n    CONCAT(CAST(ROUND((SUM(CustomerCount) * 100.0 / MAX(tc.TotalCount)), 1) AS DECIMAL(5,1)), '%') AS [% of Customer Base]\r\nFROM segmentation_metrics sm\r\nCROSS JOIN total_customers tc\r\nGROUP BY CustomerRelationshipTypeId, tc.TotalCount\r\nORDER BY SUM(CustomerCount) DESC;",
    "I need to analyze our sales performance and identify our most valuable customers. Can you show me the top-performing customers by total revenue, their order patterns, and how different customer segments contribute to our overall sales? I also want to understand seasonal trends in our sales data.": "-- Sales Performance and Customer Value Analysis\r\n\r\n-- Top 20 Customers by Total Revenue\r\nWITH customer_value AS (\r\n    SELECT \r\n        c.CustomerId,\r\n        c.FirstName,\r\n        c.LastName,\r\n        c.CustomerRelationshipTypeId,\r\n        COUNT(o.OrderId) AS TotalOrders,\r\n        SUM(o.OrderTotal) AS TotalRevenue,\r\n        ROUND(AVG(o.OrderTotal), 2) AS AvgOrderValue,\r\n        MIN(o.OrderDate) AS FirstOrderDate,\r\n        MAX(o.OrderDate) AS LastOrderDate,\r\n        DATEDIFF(DAY, MIN(o.OrderDate), MAX(o.OrderDate)) AS CustomerLifespan_Days\r\n    FROM shared.customer c\r\n    INNER JOIN salesfabric.[order] o ON c.CustomerId = o.CustomerId\r\n    WHERE o.OrderStatus = 'Completed'\r\n    GROUP BY c.CustomerId, c.FirstName, c.LastName, c.CustomerRelationshipTypeId\r\n)\r\n\r\nSELECT TOP 20\r\n    CustomerId,\r\n    FirstName,\r\n    LastName,\r\n    CustomerRelationshipTypeId,\r\n    ROUND(TotalRevenue, 2) AS TotalRevenue,\r\n    TotalOrders,\r\n    AvgOrderValue\r\nFROM customer_value\r\nORDER BY TotalRevenue DESC;\r\n\r\n-- Customer Segment Performance Analysis\r\nWITH customer_value AS (\r\n    SELECT \r\n        c.CustomerId,\r\n        c.CustomerRelationshipTypeId,\r\n        COUNT(o.OrderId) AS TotalOrders,\r\n        SUM(o.OrderTotal) AS TotalRevenue,\r\n        AVG(o.OrderTotal) AS AvgOrderValue\r\n    FROM shared.customer c\r\n    INNER JOIN salesfabric.[order] o ON c.CustomerId = o.CustomerId\r\n    WHERE o.OrderStatus = 'Completed'\r\n    GROUP BY c.CustomerId, c.CustomerRelationshipTypeId\r\n),\r\n\r\ntotal_revenue AS (\r\n    SELECT SUM(OrderTotal) AS TotalRevenue\r\n    FROM salesfabric.[order]\r\n    WHERE OrderStatus = 'Completed'\r\n)\r\n\r\nSELECT \r\n    cv.CustomerRelationshipTypeId,\r\n    COUNT(cv.CustomerId) AS CustomerCount,\r\n    ROUND(SUM(cv.TotalRevenue), 2) AS SegmentRevenue,\r\n    ROUND(AVG(cv.TotalRevenue), 2) AS AvgRevenuePerCustomer,\r\n    SUM(cv.TotalOrders) AS SegmentOrders,\r\n    ROUND(AVG(CAST(cv.TotalOrders AS FLOAT)), 1) AS AvgOrdersPerCustomer,\r\n    ROUND(AVG(cv.AvgOrderValue), 2) AS SegmentAvgOrderValue,\r\n    ROUND((SUM(cv.TotalRevenue) * 100.0 / tr.TotalRevenue), 2) AS RevenuePercentage\r\nFROM customer_value cv\r\nCROSS JOIN total_revenue tr\r\nGROUP BY cv.CustomerRelationshipTypeId, tr.TotalRevenue\r\nORDER BY SegmentRevenue DESC;\r\n\r\n-- Monthly Sales Trends\r\nSELECT \r\n    YEAR(OrderDate) AS OrderYear,\r\n    MONTH(OrderDate) AS OrderMonth,\r\n    FORMAT(OrderDate, 'yyyy-MM') AS YearMonth,\r\n    COUNT(OrderId) AS MonthlyOrders,\r\n    ROUND(SUM(OrderTotal), 2) AS MonthlyRevenue,\r\n    ROUND(AVG(OrderTotal), 2) AS MonthlyAvgOrderValue,\r\n    COUNT(DISTINCT CustomerId) AS UniqueCustomers\r\nFROM salesfabric.[order]\r\nWHERE OrderStatus = 'Completed'\r\nGROUP BY YEAR(OrderDate), MONTH(OrderDate), FORMAT(OrderDate, 'yyyy-MM')\r\nORDER BY OrderYear, OrderMonth;\r\n\r\n-- Seasonal Sales Analysis\r\nWITH seasonal_sales AS (\r\n    SELECT \r\n        CASE \r\n            WHEN MONTH(OrderDate) IN (12, 1, 2) THEN 'Winter'\r\n            WHEN MONTH(OrderDate) IN (3, 4, 5) THEN 'Spring'\r\n            WHEN MONTH(OrderDate) IN (6, 7, 8) THEN 'Summer'\r\n            ELSE 'Fall'\r\n        END AS Season,\r\n        OrderId,\r\n        OrderTotal,\r\n        CustomerId\r\n    FROM salesfabric.[order]\r\n    WHERE OrderStatus = 'Completed'\r\n),\r\n\r\ntotal_revenue AS (\r\n    SELECT SUM(OrderTotal) AS TotalRevenue\r\n    FROM salesfabric.[order]\r\n    WHERE OrderStatus = 'Completed'\r\n)\r\n\r\nSELECT \r\n    ss.Season,\r\n    COUNT(ss.OrderId) AS SeasonalOrders,\r\n    ROUND(SUM(ss.OrderTotal), 2) AS SeasonalRevenue,\r\n    ROUND(AVG(ss.OrderTotal), 2) AS SeasonalAvgOrderValue,\r\n    COUNT(DISTINCT ss.CustomerId) AS UniqueSeasonalCustomers,\r\n    ROUND((SUM(ss.OrderTotal) * 100.0 / tr.TotalRevenue), 2) AS RevenuePercentage\r\nFROM seasonal_sales ss\r\nCROSS JOIN total_revenue tr\r\nGROUP BY ss.Season, tr.TotalRevenue\r\nORDER BY SeasonalRevenue DESC;\r\n\r\n-- High-Value Customer Analysis (Top 10%)\r\nWITH customer_value AS (\r\n    SELECT \r\n        c.CustomerId,\r\n        c.FirstName,\r\n        c.LastName,\r\n        c.CustomerRelationshipTypeId,\r\n        SUM(o.OrderTotal) AS TotalRevenue,\r\n        COUNT(o.OrderId) AS TotalOrders\r\n    FROM shared.customer c\r\n    INNER JOIN salesfabric.[order] o ON c.CustomerId = o.CustomerId\r\n    WHERE o.OrderStatus = 'Completed'\r\n    GROUP BY c.CustomerId, c.FirstName, c.LastName, c.CustomerRelationshipTypeId\r\n),\r\n\r\ncustomer_percentile AS (\r\n    SELECT \r\n        *,\r\n        NTILE(10) OVER (ORDER BY TotalRevenue DESC) AS RevenueDecile\r\n    FROM customer_value\r\n)\r\n\r\nSELECT \r\n    COUNT(*) AS HighValueCustomerCount,\r\n    ROUND(SUM(TotalRevenue), 2) AS HighValueRevenue,\r\n    ROUND(AVG(TotalRevenue), 2) AS AvgHighValueRevenue,\r\n    SUM(TotalOrders) AS HighValueOrders\r\nFROM customer_percentile\r\nWHERE RevenueDecile = 1;",
    "I need to analyze our product performance to understand which products are driving revenue. Can you show me the top-selling products by revenue and quantity, product performance by category, and identify which products have the best profit margins? I also want to see how product preferences vary across different customer segments.": "-- Product Performance Analysis\r\n\r\n-- Top 15 Products by Revenue\r\nWITH product_sales AS (\r\n    SELECT \r\n        p.ProductID,\r\n        p.ProductName,\r\n        p.CategoryName,\r\n        p.StandardCost,\r\n        p.ListPrice,\r\n        ol.Quantity,\r\n        ol.UnitPrice,\r\n        (ol.Quantity * ol.UnitPrice) AS LineRevenue,\r\n        ((ol.Quantity * ol.UnitPrice) - (ol.Quantity * p.StandardCost)) AS LineProfit,\r\n        o.CustomerId\r\n    FROM salesfabric.orderline ol\r\n    INNER JOIN salesfabric.[order] o ON ol.OrderId = o.OrderId\r\n    INNER JOIN shared.product p ON ol.ProductId = p.ProductID\r\n    WHERE o.OrderStatus = 'Completed'\r\n)\r\n\r\nSELECT TOP 15\r\n    ProductID,\r\n    ProductName,\r\n    CategoryName,\r\n    ROUND(SUM(LineRevenue), 2) AS TotalRevenue,\r\n    SUM(Quantity) AS TotalUnitsSold,\r\n    COUNT(DISTINCT CustomerId) AS UniqueCustomers,\r\n    COUNT(*) AS OrderLines,\r\n    ROUND(SUM(LineRevenue) / COUNT(DISTINCT CustomerId), 2) AS AvgRevenuePerCustomer\r\nFROM product_sales\r\nGROUP BY ProductID, ProductName, CategoryName\r\nORDER BY TotalRevenue DESC;\r\n\r\n-- Product Category Performance\r\nWITH product_sales AS (\r\n    SELECT \r\n        p.ProductID,\r\n        p.CategoryName,\r\n        ol.Quantity,\r\n        ol.UnitPrice,\r\n        (ol.Quantity * ol.UnitPrice) AS LineRevenue,\r\n        ((ol.Quantity * ol.UnitPrice) - (ol.Quantity * p.StandardCost)) AS LineProfit,\r\n        o.CustomerId\r\n    FROM salesfabric.orderline ol\r\n    INNER JOIN salesfabric.[order] o ON ol.OrderId = o.OrderId\r\n    INNER JOIN shared.product p ON ol.ProductId = p.ProductID\r\n    WHERE o.OrderStatus = 'Completed'\r\n)\r\n\r\nSELECT \r\n    CategoryName,\r\n    COUNT(DISTINCT ProductID) AS ProductsInCategory,\r\n    ROUND(SUM(LineRevenue), 2) AS CategoryRevenue,\r\n    SUM(Quantity) AS CategoryUnitsSold,\r\n    COUNT(DISTINCT CustomerId) AS CategoryCustomers,\r\n    ROUND(AVG((LineProfit * 100.0) / LineRevenue), 2) AS AvgProfitMargin,\r\n    ROUND(SUM(LineRevenue) / COUNT(DISTINCT ProductID), 2) AS RevenuePerProduct\r\nFROM product_sales\r\nGROUP BY CategoryName\r\nORDER BY CategoryRevenue DESC;\r\n\r\n-- Top 12 Most Profitable Products (Revenue > $1,000)\r\nWITH product_sales AS (\r\n    SELECT \r\n        p.ProductID,\r\n        p.ProductName,\r\n        p.CategoryName,\r\n        p.StandardCost,\r\n        p.ListPrice,\r\n        ol.Quantity,\r\n        ol.UnitPrice,\r\n        (ol.Quantity * ol.UnitPrice) AS LineRevenue,\r\n        ((ol.Quantity * ol.UnitPrice) - (ol.Quantity * p.StandardCost)) AS LineProfit\r\n    FROM salesfabric.orderline ol\r\n    INNER JOIN salesfabric.[order] o ON ol.OrderId = o.OrderId\r\n    INNER JOIN shared.product p ON ol.ProductId = p.ProductID\r\n    WHERE o.OrderStatus = 'Completed'\r\n),\r\n\r\nproduct_profitability AS (\r\n    SELECT \r\n        ProductID,\r\n        ProductName,\r\n        CategoryName,\r\n        StandardCost,\r\n        ListPrice,\r\n        SUM(LineProfit) AS TotalProfit,\r\n        SUM(LineRevenue) AS TotalRevenue,\r\n        SUM(Quantity) AS TotalQuantity,\r\n        AVG((LineProfit * 100.0) / LineRevenue) AS AvgMargin\r\n    FROM product_sales\r\n    GROUP BY ProductID, ProductName, CategoryName, StandardCost, ListPrice\r\n    HAVING SUM(LineRevenue) > 1000\r\n)\r\n\r\nSELECT TOP 12\r\n    ProductID,\r\n    ProductName,\r\n    CategoryName,\r\n    ROUND(TotalProfit, 2) AS TotalProfit,\r\n    ROUND(TotalRevenue, 2) AS TotalRevenue,\r\n    TotalQuantity,\r\n    ROUND(AvgMargin, 2) AS AvgMargin,\r\n    ROUND(TotalProfit / TotalQuantity, 2) AS ProfitPerUnit\r\nFROM product_profitability\r\nORDER BY TotalProfit DESC;\r\n\r\n-- Product Category Preferences by Customer Segment\r\nWITH product_sales AS (\r\n    SELECT \r\n        p.CategoryName,\r\n        c.CustomerRelationshipTypeId,\r\n        ol.Quantity,\r\n        (ol.Quantity * ol.UnitPrice) AS LineRevenue,\r\n        p.ProductID,\r\n        o.CustomerId\r\n    FROM salesfabric.orderline ol\r\n    INNER JOIN salesfabric.[order] o ON ol.OrderId = o.OrderId\r\n    INNER JOIN shared.product p ON ol.ProductId = p.ProductID\r\n    INNER JOIN shared.customer c ON o.CustomerId = c.CustomerId\r\n    WHERE o.OrderStatus = 'Completed'\r\n),\r\n\r\nsegment_category AS (\r\n    SELECT \r\n        CustomerRelationshipTypeId,\r\n        CategoryName,\r\n        SUM(LineRevenue) AS SegmentCategoryRevenue,\r\n        SUM(Quantity) AS SegmentCategoryQuantity,\r\n        COUNT(DISTINCT ProductID) AS ProductVariety,\r\n        COUNT(DISTINCT CustomerId) AS CustomersInSegment\r\n    FROM product_sales\r\n    GROUP BY CustomerRelationshipTypeId, CategoryName\r\n),\r\n\r\nsegment_totals AS (\r\n    SELECT \r\n        CustomerRelationshipTypeId,\r\n        SUM(SegmentCategoryRevenue) AS SegmentTotal\r\n    FROM segment_category\r\n    GROUP BY CustomerRelationshipTypeId\r\n)\r\n\r\nSELECT \r\n    sc.CustomerRelationshipTypeId,\r\n    sc.CategoryName,\r\n    ROUND(sc.SegmentCategoryRevenue, 2) AS SegmentCategoryRevenue,\r\n    ROUND((sc.SegmentCategoryRevenue * 100.0 / st.SegmentTotal), 1) AS CategoryShare,\r\n    sc.ProductVariety,\r\n    sc.CustomersInSegment\r\nFROM segment_category sc\r\nINNER JOIN segment_totals st ON sc.CustomerRelationshipTypeId = st.CustomerRelationshipTypeId\r"
}